{% extends 'layout.njk' %}

{% block content %}
<header class="ui fluid stackable grid" id="dashboard-header-grid">
  <div class="row" id="dashboard-header-row-top">
    <div class="eight wide column">
      <img id="logo" src="/logo.png">
    </div>

    <div class="eight wide column" id = "dashboard-header-stats">
    <div class="bar-chart-border">
      <div class="chart">
        <div class="all-backups-bar" style = "--bar-value: {{ ((machineStatuses.allBackups)/(machineStatuses.total)) * 100 }}%;">
          <span class="dashboard-stats-numbers">{{ machineStatuses.allBackups }}</span>
          </div>
        <div class="some-backups-bar" style = "--bar-value: {{ ((machineStatuses.someBackups)/(machineStatuses.total)) * 100 }}%;">
          <span class="dashboard-stats-numbers">{{ machineStatuses.someBackups }}</span>
          </div>
        <div class="no-backups-bar" style = "--bar-value: {{ ((machineStatuses.noBackups)/(machineStatuses.total)) * 100 }}%;">
          <span class="dashboard-stats-numbers">{{ machineStatuses.noBackups }}</span>
          </div>
        <div class="idle-bar" style = "--bar-value: {{ ((machineStatuses.idle)/(machineStatuses.total)) * 100 }}%;">
          <span class="dashboard-stats-numbers">{{ machineStatuses.idle }}</span>
        </div>
      </div>
      <div class="x-axis">
        <ul class="legend">
          <li><a class="ui green empty circular label"></a> All Backups</li>
          <li><a class="ui yellow empty circular label"></a> Some Backups</li>
          <li><a class="ui red empty circular label"></a> No Backups</li>
          <li><a class="ui grey empty circular label"></a> Idle</li>
        </ul>
      </div>
    </div>
  </div>
</div>
<div class="ui container dashboard-body">
  <div class="ui fluid stackable grid">
    <div class="three column row">
      <div class="column">
        <div class="ui segment dashboard-header-segment">
          Total Backup Size: <br /> <span class="dashboard-bold" id="totalSize">...</span>
          <div class="ui popup" id="totalSizePopup"></div>
        </div>
      </div>
      <div class="column">
        <div class="ui segment dashboard-header-segment">
          Free Space: <br /> <span class="dashboard-bold" id="freeSpace">...</span>
        </div>
      </div>
      <div class="column">
        <div class="ui segment dashboard-header-segment">
          Running since: <br /> <span class="dashboard-bold"> {{ lastBackupSystemRestart }} </span>
        </div>
      </div>
    </div>
  </div>

  <table class="ui striped selectable sortable celled table" id="dashboard-table">
    <thead>
      <tr>
        <th class="dashboard-table-name"> Machine Name </th>
        <th class="dashboard-table-progress"> Progress </th>
        <th class="dashboard-table-status"> Status </th>
        <th class="dashboard-table-size"> Total Size </th>
        <th> Last Successful Backup </th>
      </tr>
    </thead>
    <tbody>
      {% for machine in machines %}
      <tr id="{{ machine.name | lower }}-row">
          <td>
            <a
              id ="machine-link"
              href="/machine/{{ machine.name }}?showRequestedBackups=true&showScheduledBackups=true?" 
              class="dashboard-bold">
              {{ machine.name }}
            </a>
          </td>

          {% for machine in machines %}
          {% if machine.inProgress == true %}
          <td>
          <div "backupInProgress"><div class="ui active inline small blue elastic loader"></div>
          started {{machine.backupStartTime}} ago </div>
          </td>

          {% else %}
          {% if machine.backupRetryTime == -1 %}
          <td>
          <span class="backupSuccessful"> No backup in progress </span>
          </td>
          
          {% elif machine.backupRetryTime == 0 %}
          <td>
          <span class="backupFailedNoRetry"> Last backup failed: started {{machine.backupStartTime}} ago. No more attempts will be made to complete this backup. </span>
          </td>
          {% else %}
          <td>
          <span class="backupFailed"> Last backup failed: started {{machine.backupStartTime}} ago. Next attempt scheduled for {{machine.formattedBackupRetryTime}}. </span>
          </td>
          
          {% endif %}
          {% endif %}

          {% endfor %}

          <!--Spacing is very important; please do not change it.-->
          {% if machine.scheduledBackups == 0 %}
            <td>
              <span class="dashboard-grey">   <i class="minus icon"></i>
              {{ machine.successfulBackups }} of {{ machine.scheduledBackups }} backups successful</span>
            </td>
          {% elif machine.scheduledBackups == machine.successfulBackups %}
            <td>
              <span class="dashboard-green"><i class="thumbs up icon"></i></span>
              {{ machine.successfulBackups }} of {{ machine.scheduledBackups }} backups successful
            </td>
          {% elif machine.successfulBackups == 0 %}
            <td class="error">
              <i class="attention icon"></i>
              {{ machine.successfulBackups }} of {{ machine.scheduledBackups }} backups successful
            </td>
          {% else %}
            <td class="warning">
              <span class=dashboard-yellow><i class="question icon"></i></span>
              {{ machine.successfulBackups }} of {{ machine.scheduledBackups }} backups successful
            </td>
          {% endif %}
          <td>
            <span class="machine-size">{{ machine.totalSize }}</span>
          </td>
          <td>{{ machine.timeSinceLastBackup }}</td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
  <div id="gmt-offset-panel" class="ui segment">
    <h3 id="gmt-header">Timezone GMT Offset:</h3>
    <div id="gmt-row">
      <p class="gmt-child">GMT:</p>
      <input id="gmt-input" class="gmt-child" type="text" placeholder="+x/-x" />
      <p p id="extra-gmt-text">(In hours)</p>
    </div>
    <h6 id="gmt-description">
      (This is used to display backups in your timezone,
      <a href="https://www.google.com/search?q=what%27s+my+timezone" target="_blank">&nbsp check yours here</a>
      )
    </h6>
  </div>
</div>
<div class="template" id="sizePopupTemplate">
  <div class="content">
    <div class="header">Details</div>
    <div class="description">
      <p><b>Type:</b> <span class="type">...</span></p>
      <p><b>When:</b> <span class="time">...</span></p>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
  <script src="/js/vendor/jquery.tablesort.min.js"></script>
  <script src="/js/dashboard.js"></script>
  <script>
    const gmtInputElement = document.getElementById('gmt-input');
    const machineLinkElement = document.getElementById('machine-link');
    const currentGmtOffset = localStorage.getItem('gmtOffsetHours');

    function setMachineLinkGMT(gmtOffsetHours) {
      if (!gmtOffsetHours)
        return console.error('Tried setting the GMT offset in the machine link to a falsy value, aborting...');

      const url = new URL(machineLinkElement.href);
      url.searchParams.set('gmtOffsetHours', gmtOffsetHours);
      machineLinkElement.href = url.href;
    }

    if (isNaN(currentGmtOffset)) {
      gmtInputElement.value = '';
      setMachineLinkGMT(null);
    } else {
      gmtInputElement.value = (currentGmtOffset > 0 ? '+' : '') + currentGmtOffset;
      setMachineLinkGMT(currentGmtOffset);
    }

    gmtInputElement.addEventListener('input', onGmtChange);

    function onGmtChange(event) {
      const newGmt = gmtInputElement.value;

      if (newGmt.split('+').length > 2 || newGmt.split('-').length > 2) {
        localStorage.setItem('gmtOffsetHours', null);
        return console.error('GMT offset has multiple signs, abandoning..');
      }

      if (!newGmt) {
        localStorage.setItem('gmtOffsetHours', null);
        return console.error('No GMT!');
      }

      if (!newGmt.startsWith('-') && !newGmt.startsWith('+')) {
        localStorage.setItem('gmtOffsetHours', null);
        return console.error('Cant parse GMT, needs + or -')
      }

      const parsedNewGmt = Number(newGmt);

      if (isNaN(parsedNewGmt)) {
        localStorage.setItem('gmtOffsetHours', null);
        return console.error('Number could not be parsed (returned NaN)')
      }

      localStorage.setItem('gmtOffsetHours', Number(newGmt));
      setMachineLinkGMT(Number(newGmt));
    }
  </script>
  <script class="text/javascript"> $('table').tablesort(); </script>
{% endblock %}
